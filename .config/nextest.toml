# Nextest configuration for save-rust
# Veilid/DHT tests can be slow and flaky due to P2P peer discovery and network setup.

[profile.default]
# Set timeout to 10 minutes per test (Veilid network operations can be slow)
# Terminate after 10 periods of 60s.
slow-timeout = { period = "60s", terminate-after = 10 }

# Retry flaky tests with exponential backoff to give Veilid time to connect
retries = { backoff = "exponential", count = 3, delay = "5s", max-delay = "30s" }

# Run tests serially to avoid Veilid network conflicts
test-threads = 1

# P2P tests are flaky in CI, but very high retry counts can stretch failures to >1h.
# Keep retries moderate so truly broken runs fail fast.
[[profile.default.overrides]]
filter = 'test(test_replicate_group) | test(test_join_group)'
retries = { backoff = "exponential", count = 4, delay = "8s", max-delay = "45s", jitter = true }

[[profile.default.overrides]]
filter = 'test(test_refresh_joined_group)'
retries = { backoff = "exponential", count = 2, delay = "8s", max-delay = "30s", jitter = true }
slow-timeout = { period = "60s", terminate-after = 5 }

# Faster CI profile used for PR runs.
[profile.ci-virtual]
slow-timeout = { period = "30s", terminate-after = 4 }
retries = { backoff = "exponential", count = 1, delay = "3s", max-delay = "10s", jitter = true }
test-threads = 1

[[profile.ci-virtual.overrides]]
filter = 'test(test_replicate_group) | test(test_join_group)'
retries = { backoff = "exponential", count = 2, delay = "5s", max-delay = "20s", jitter = true }
slow-timeout = { period = "45s", terminate-after = 4 }

[[profile.ci-virtual.overrides]]
filter = 'test(test_refresh_joined_group)'
retries = { backoff = "exponential", count = 1, delay = "5s", max-delay = "15s", jitter = true }
slow-timeout = { period = "45s", terminate-after = 4 }
